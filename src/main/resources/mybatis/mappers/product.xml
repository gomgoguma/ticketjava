<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="product">

	<!-- 공연 리스트 불러오기 -->
	<select id="getProductList" resultType="productVo">
		<![CDATA[
			select  	prod_no prodNo,
			        		t.theatername theaterName,
			        		prodname prodName,
	                    	to_char(beginshow, 'YYYY-MM-DD') beginShow,
	                    	to_char(endshow, 'YYYY-MM-DD') endShow,
			        		status status
			        
			from    	product p,
			        		theater t,
			        		hall h
			where   	p.hall_no = h.hall_no
			       		and h.theater_no = t.theater_no
		
		]]>
	</select>

	<!-- product 테이블 공연 불러오기 -->
	<insert id="productUpload" parameterType="productVo">
	
		<selectKey keyProperty="productNo" resultType="int" order="BEFORE">
			select seq_product_no.nextval from dual
		</selectKey>
        <![CDATA[
		insert into 	product		(prod_no, prodName, prodType, beginShow, endShow, beginRez, endRez,  viewTime, viewGrade, notice, posterpath, cancelInfo, showTime, status) 
            				values 		(seq_prod_no.nextval, #{prodName}, #{prodType}, #{beginShow}, #{endShow}, #{beginRez}, #{endRez}, #{viewTime}, #{viewGrade}, #{notice}, #{posterPath}, #{cancelInfo}, to_date(#{showTime},'HH24:MI'), 1)
        ]]>
        
	</insert>


	<!-- product 테이블 파일 추가 -->
	<!-- <insert id="productUpload" parameterType="productVo"> -->
	<!-- <![CDATA[ -->
	<!-- insert into product (prod_no, prodName, prodType, beginShow, endShow, beginRez, endRez, viewTime, viewGrade, notice, posterpath, cancelInfo, showTime, status) -->
	<!-- values (seq_prod_no.nextval, #{prodName}, #{prodType}, #{beginShow}, #{endShow}, #{beginRez}, #{endRez}, #{viewTime}, #{viewGrade}, #{notice}, #{posterPath}, #{cancelInfo}, to_date(#{showTime},'HH24:MI'), 1) -->

	<!-- ]]> -->
	<!-- </insert> -->

	<!-- 공연 삭제 -->
	<delete id="productDelete" parameterType="ProductVo">
		<![CDATA[
				delete from 	product
				where 			prod_no = #{prodNo}
		]]>
	</delete>


	<!-- 평점 top4 리스트 -->
	<select id="topList" parameterType="ProductVo" resultType="ProductVo">
		<![CDATA[
			select			p.prod_no prodNo, 
       						prodname,
       						p.prodtype prodType,
       						r.rn rn,
       						to_char(beginshow, 'YYYY-MM-DD') beginshow, 
       						to_char(endshow, 'YYYY-MM-DD') endshow, 
       						hallname,
       						posterpath,
       						theatername
			from 			product p, hall h, theater t, 
                			(select  	rownum rn,
                         				p.prod_no,
                         				prodtype,
                         				rating
                 			 from    	product p, (select 		prod_no, avg(rating) rating
                                     				from 		review
                                     				group by 	prod_no
                                     				order by 	rating desc) o
                 			 where  	p.prod_no= o.prod_no
                 			 and    	rownum between 1 and 4
                 			 and   		prodtype= #{prodType}) r               
			where 			p.prod_no= r.prod_no
			and 			p.hall_no= h.hall_no
			and 			h.theater_no= t.theater_no
			and 			status= 1
			and 			p.prodtype= #{prodType}
		]]>
	</select>


	<!-- 상품 리스트 -->
	<select id="allList" parameterType="ProductVo" resultType="ProductVo">
		<![CDATA[
			select			p.prod_no prodNo, 
							prodname, 
							to_char(beginshow, 'YYYY-MM-DD') beginshow, 
							to_char(endshow, 'YYYY-MM-DD') endshow, 
							hallname,
							posterpath, 
							theatername
			from 			product p, hall h, theater t
			where 			p.hall_no= h.hall_no
			and 			h.theater_no= t.theater_no
			and 			status= 1
			and 			prodtype= #{prodType}
		]]>
	</select>


	<!-- 상품 상세정보 -->
	<select id="getProduct" parameterType="ProductVo" resultType="ProductVo">
		<![CDATA[
			select			p.prod_no prodNo,
        					prodname,
        					p.hall_no hallNo,
        					hallname,
        					prodtype,
        					to_char(beginshow, 'YYYY-MM-DD') beginshow, 
        					to_char(endshow, 'YYYY-MM-DD') endshow,
        					beginrez,
        					endrez,
        					showtime,
        					viewtime,
        					viewgrade,
        					notice,
        					cancelinfo,
        					status,
        					posterpath,
        					t.theatername theaterName
			from    		product p, hall h, theater t
			where   		p.hall_no= h.hall_no
			and     		h.theater_no= t.theater_no
			and				status= 1
			and     		p.prod_no= #{prodNo}
		]]>
	</select>


	<!-- 특정 공연장 예매가능 상품 리스트 -->
	<select id="availListbyTheater" parameterType="ProductVo" resultType="ProductVo">
		<![CDATA[
			select			p.prod_no prodNo,
        					p.hall_no hallNo,
        					h.hallname hallName,
        					prodname,
        					prodtype,
        					to_char(beginshow, 'YYYY-MM-DD') beginshow, 
        					to_char(endshow, 'YYYY-MM-DD') endshow,
        					to_char(beginrez, 'YYYY-MM-DD') beginrez, 
        					to_char(endrez, 'YYYY-MM-DD') endrez,
        					viewtime,
        					viewgrade,
        					status,
        					posterpath,
        					t.theater_no theaterNo,
        					t.theatername theaterName
			from 			product p, hall h, theater t
			where 			p.hall_no= h.hall_no
			and   			h.theater_no= t.theater_no
			and				status= 1
			and    			sysdate < endrez 
			and    			beginrez < sysdate
			and   			t.theater_no= #{theaterNo}
		]]>
	</select>


	<!-- 공연장별 top5 상품 불러오기 -->
	<select id="topListbyTheater" parameterType="ProductVo" resultType="ProductVo">
		<![CDATA[
			select 			p.prod_no prodNo,
        					p.hall_no hallNo,
        					h.hallname hallName,
        					prodname,
        					prodtype,
        					to_char(beginshow, 'YYYY-MM-DD') beginshow, 
        					to_char(endshow, 'YYYY-MM-DD') endshow,
        					to_char(beginrez, 'YYYY-MM-DD') beginrez, 
        					to_char(endrez, 'YYYY-MM-DD') endrez,
        					viewtime,
        					viewgrade,
        					status,
        					posterpath,
        					o.rating,
        					t.theater_no theaterNo,
        					t.theatername theaterName
			from 			product p, hall h, theater t,
    						(select 	rownum rn,
            							prodNo,
            							rating
     						 from  		(select 	prod_no prodNo,
     						 						avg(rating) rating
             							 from review
             							 group by prod_no
             							 order by rating desc)) o 
			where 			p.hall_no= h.hall_no
			and   			h.theater_no= t.theater_no
			and   			p.prod_no= o.prodno
			and				status= 1
			and   			t.theater_no= #{theaterNo}
		]]>
	</select>


	<!-- 검색결과 -->
	<select id="searchResult" parameterType="String" resultType="ProductVo">
		<![CDATA[
			select			prod_no prodNo,
            				prodname,
            				h.hall_no hallNo,
            				h.hallname hallName,
            				prodtype,
            				to_char(beginshow, 'YYYY-MM-DD') beginshow, 
				            to_char(endshow, 'YYYY-MM-DD') endshow,
				            viewtime,
				            viewgrade,
				            posterpath,
				            status,
				            t.theater_no theaterNo,
				            theatername
			from        	product p, hall h, theater t
			where       	p.hall_no= h.hall_no
			and         	h.theater_no= t.theater_no
			and         	status= 1
			and         	prodname like '%'||#{key}||'%'
		]]>
	</select>

	<!-- 검색결과 카운트 -->
	<select id="countResult" parameterType="String" resultType="int">
		<![CDATA[
			select 			count(*)
			from    		(select         prod_no prodNo,
					                        prodname,
					                        h.hall_no hallNo,
					                        h.hallname hallName,
					                        prodtype,
					                        to_char(beginshow, 'YYYY-MM-DD') beginshow, 
					                        to_char(endshow, 'YYYY-MM-DD') endshow,
					                        viewtime,
					                        viewgrade,
					                        posterpath,
					                        status,
					                        t.theater_no theaterNo,
					                        theatername
            from        	product p, hall h, theater t
            where       	p.hall_no= h.hall_no
            and         	h.theater_no= t.theater_no
            and         	status= 1
            and         	prodname like '%'||#{key}||'%')
		]]>
	</select>


	<!-- 모든상품 리스트 (지역페이지) cateNo=0 -->
	<select id="allprod" resultType="ProductVo">
		<![CDATA[
			select			p.prod_no prodNo, 
							prodname, 
							to_char(beginshow, 'YYYY-MM-DD') beginshow, 
							to_char(endshow, 'YYYY-MM-DD') endshow, 
							hallname,
							posterpath, 
							theatername
			from 			product p, hall h, theater t
			where 			p.hall_no= h.hall_no
			and 			h.theater_no= t.theater_no
			and 			status= 1
		]]>
	</select>

	<!-- 서울/경기 cateNo=1 -->
	<select id="skprod" resultType="ProductVo">
		<![CDATA[
			select			p.prod_no prodNo, 
                			prodname, 
			                to_char(beginshow, 'YYYY-MM-DD') beginshow, 
			                to_char(endshow, 'YYYY-MM-DD') endshow, 
			                hallname,
			                posterpath,
			                address,
			                theatername
			from 			product p, hall h, theater t
			where 			p.hall_no= h.hall_no
			and 			h.theater_no= t.theater_no
			and 			status= 1
			and             (address like '서울'||'%' or address like '경기'||'%' 
							 or address like '인천'||'%')
		]]>
	</select>

	<!-- 강원/충청 cateNo=2 -->
	<select id="gcprod" resultType="ProductVo">
		<![CDATA[
			select			p.prod_no prodNo, 
                			prodname, 
			                to_char(beginshow, 'YYYY-MM-DD') beginshow, 
			                to_char(endshow, 'YYYY-MM-DD') endshow, 
			                hallname,
			                posterpath,
			                address,
			                theatername
			from 			product p, hall h, theater t
			where 			p.hall_no= h.hall_no
			and 			h.theater_no= t.theater_no
			and 			status= 1
			and             (address like '강원'||'%' or address like '충북'||'%' 
							 or address like '충남'||'%' or address like '대전'||'%')
		]]>
	</select>


	<!-- 전라 cateNo=3 -->
	<select id="jprod" resultType="ProductVo">
		<![CDATA[
			select			p.prod_no prodNo, 
                			prodname, 
			                to_char(beginshow, 'YYYY-MM-DD') beginshow, 
			                to_char(endshow, 'YYYY-MM-DD') endshow, 
			                hallname,
			                posterpath,
			                address,
			                theatername
			from 			product p, hall h, theater t
			where 			p.hall_no= h.hall_no
			and 			h.theater_no= t.theater_no
			and 			status= 1
			and             (address like '전남'||'%' or address like '전북'||'%' 
							 or address like '광주'||'%')
		]]>
	</select>

	<!-- 경상/제주 cateNo=4 -->
	<select id="kjprod" resultType="ProductVo">
		<![CDATA[
			select			p.prod_no prodNo, 
                			prodname, 
			                to_char(beginshow, 'YYYY-MM-DD') beginshow, 
			                to_char(endshow, 'YYYY-MM-DD') endshow, 
			                hallname,
			                posterpath,
			                address,
			                theatername
			from 			product p, hall h, theater t
			where 			p.hall_no= h.hall_no
			and 			h.theater_no= t.theater_no
			and 			status= 1
			and             (address like '경남'||'%' or address like '경북'||'%' 
							 or address like '대구'||'%' or address like '부산'||'%' 
							 or address like '울산'||'%' or address like '제주'||'%')
		]]>
	</select>

	
	
	<!-- prodType별 TOP5 -->
	<select id="topListbyType" parameterType="int" resultType="ProductVo">
		<![CDATA[
			select			p.prod_no prodNo, 
					        prodname,
					        p.prodtype prodType,
					        r.rn,
					        to_char(beginshow, 'YYYY-MM-DD') beginshow, 
					        to_char(endshow, 'YYYY-MM-DD') endshow, 
					        hallname,
					        posterpath,
					        theatername
			from 			product p, hall h, theater t, 
                			(select  	rownum rn,
                         				p.prod_no,
                         				prodtype,
                         				rating
                 			 from    	product p, (select r.prod_no, avg(rating) rating
                                     				from review r
                                     				group by prod_no
                                     				order by rating desc) o
                 			 where  p.prod_no= o.prod_no
			                 and    rownum between 1 and 5
			                 and   prodtype= #{prodType}) r               
			where 			p.prod_no= r.prod_no
			and 			p.hall_no= h.hall_no
			and 			h.theater_no= t.theater_no
			and 			status= 1
			and 			p.prodtype= #{prodType}
		]]>
	</select>
	
>>>>>>> branch 'master' of https://github.com/lisiee0/ticketjava.git
</mapper>